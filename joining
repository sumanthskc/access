CREATE TABLE unified_network_analysis
WITH (
     format = 'PARQUET',
     external_location = 's3://ist-network-intelligence-vpcflowlogs-curated/preaggregate/unified_layer/',
     partitioned_by = ARRAY['year', 'month', 'day']
) AS
-- Step 1: Dedup DNS logs so 1 IP maps to 1 Domain per Client per Day
WITH deduped_dns AS (
    SELECT 
        account_id, vpc_id, client_ip, resolved_ip, year, month, day,
        -- Get the most frequently queried domain for this IP today
        MAX_BY(domain, query_count) as primary_domain 
    FROM route53_dns_daily_summary
    GROUP BY account_id, vpc_id, client_ip, resolved_ip, year, month, day
)
SELECT 
    v.account_id,
    v.region,
    v.vpc_id,
    v.instance_id,
    v.srcaddr AS client_ip,
    v.dstaddr AS destination_ip,
    r.primary_domain AS domain,
    v.pkt_dst_aws_service,
    v.traffic_path,
    SUM(v.total_bytes) AS total_bytes,
    SUM(v.total_packets) AS total_packets,
    v.year,
    v.month,
    v.day
FROM vpc_flow_daily_summary v
LEFT JOIN deduped_dns r 
    ON v.dstaddr = r.resolved_ip
    AND v.srcaddr = r.client_ip
    AND v.account_id = r.account_id
    AND v.vpc_id = r.vpc_id -- Added VPC ID for safer multi-vpc environments
    AND v.year = r.year 
    AND v.month = r.month 
    AND v.day = r.day
GROUP BY 
    v.account_id, v.region, v.vpc_id, v.instance_id, v.srcaddr, 
    v.dstaddr, r.primary_domain, v.pkt_dst_aws_service, v.traffic_path,
    v.year, v.month, v.day;
